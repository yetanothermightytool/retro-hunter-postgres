#!/usr/bin/env python3
import csv
import psycopg2
import os
from dotenv import load_dotenv

# .env laden
load_dotenv(dotenv_path=".env.local")

CSV_PATH = "malwarebazaar.csv"

def reset_table(cur):
   cur.execute("DROP TABLE IF EXISTS malwarebazaar")
   cur.execute("""
       CREATE TABLE malwarebazaar (
           sha256 TEXT PRIMARY KEY,
           file_name TEXT,
           signature TEXT,
           vtpercent TEXT,
           imphash TEXT,
           ssdeep TEXT,
           tlsh TEXT
       )
   """)

def import_csv(cur):
   inserted = 0
   with open(CSV_PATH, "r", encoding="utf-8", errors="ignore") as f:
       for line in f:
           if line.startswith("#"):
               continue
           parts = [p.strip().strip('"') for p in line.strip().split(",")]
           if len(parts) < 14:
               continue
           sha256 = parts[1]
           file_name = parts[5]
           signature = parts[8]
           vtpercent = parts[10]
           imphash = parts[11]
           ssdeep = parts[12]
           tlsh = parts[13]
           if not sha256:
               continue
           cur.execute("""
               INSERT INTO malwarebazaar
               (sha256, file_name, signature, vtpercent, imphash, ssdeep, tlsh)
               VALUES (%s, %s, %s, %s, %s, %s, %s)
               ON CONFLICT (sha256) DO NOTHING
           """, (sha256, file_name, signature, vtpercent, imphash, ssdeep, tlsh))
           inserted += 1
   print(f"âœ… Import done: {inserted} entries added.")

def main():
   conn = psycopg2.connect(
       host=os.getenv("POSTGRES_HOST", "localhost"),
       port=os.getenv("POSTGRES_PORT", 5432),
       user=os.getenv("POSTGRES_USER"),
       password=os.getenv("POSTGRES_PASSWORD"),
       dbname=os.getenv("POSTGRES_DB")
   )
   cur = conn.cursor()
   reset_table(cur)
   import_csv(cur)
   conn.commit()
   cur.close()
   conn.close()

if __name__ == "__main__":
   main()

